v {xschem version=3.4.8RC file_version=1.2}
G {}
K {}
V {}
S {}
F {}
E {}
N -70 -110 -70 -90 {lab=ITAIL}
N -70 -90 10 -90 {lab=ITAIL}
N 90 -110 90 -90 {lab=ITAIL}
N 10 -90 90 -90 {lab=ITAIL}
N -70 -230 -70 -170 {lab=Vpo}
N 90 -230 90 -170 {lab=Vout1}
N -150 -140 -110 -140 {lab=VN}
N -370 160 -370 200 {lab=VSS}
N -70 -140 90 -140 {lab=VSS}
N -70 -270 -70 -230 {lab=Vpo}
N -70 -250 -30 -250 {lab=Vpo}
N -30 -250 -10 -250 {lab=Vpo}
N -10 -300 -10 -250 {lab=Vpo}
N -30 -300 50 -300 {lab=Vpo}
N -70 -370 -70 -330 {lab=VDD}
N -70 -370 90 -370 {lab=VDD}
N 90 -370 90 -330 {lab=VDD}
N 90 -270 90 -230 {lab=Vout1}
N -370 -310 -370 -70 {lab=IBIAS}
N -330 130 -30 130 {lab=#net1}
N 10 -90 10 -70 {lab=ITAIL}
N 10 160 10 200 {lab=#net2}
N 10 130 100 130 {lab=VSS}
N 330 -210 330 -130 {lab=VOUT}
N 560 -170 560 -110 {lab=VOUT}
N 560 -50 560 -20 {lab=#net2}
N 90 -260 240 -260 {lab=Vout1}
N 560 -170 640 -170 {lab=VOUT}
N 460 -170 560 -170 {lab=VOUT}
N 330 -170 460 -170 {lab=VOUT}
N 230 120 290 120 {lab=#net1}
N -100 0 -30 0 {lab=EN}
N 10 30 10 100 {lab=#net3}
N -370 30 -370 100 {lab=#net1}
N 240 0 290 0 {lab=EN}
N -70 0 -70 50 {lab=EN}
N -200 50 -70 50 {lab=EN}
N -200 0 -200 50 {lab=EN}
N -330 0 -200 0 {lab=EN}
N -70 50 220 50 {lab=EN}
N 240 0 240 50 {lab=EN}
N -370 -70 -370 -30 {lab=IBIAS}
N -120 130 -120 210 {lab=#net1}
N 10 -70 10 -30 {lab=ITAIL}
N -120 210 210 210 {lab=#net1}
N 560 -20 560 200 {lab=#net2}
N 10 200 10 220 {lab=#net2}
N 10 280 10 290 {lab=#net2}
N -370 200 -370 300 {lab=VSS}
N 10 290 10 300 {lab=#net2}
N 10 300 10 340 {lab=#net2}
N 10 -430 10 -370 {lab=VDD}
N 260 -260 290 -260 {lab=Vout1}
N 330 -230 330 -210 {lab=VOUT}
N 230 120 230 210 {lab=#net1}
N 330 -130 330 -80 {lab=VOUT}
N 240 -180 240 -160 {lab=#net4}
N 240 -100 240 -90 {lab=VOUT}
N 240 -90 330 -90 {lab=VOUT}
N 240 -260 240 -250 {lab=Vout1}
N 240 -190 240 -180 {lab=#net4}
N 560 200 560 300 {lab=#net2}
N -390 300 -370 300 {lab=VSS}
N -410 300 -390 300 {lab=VSS}
N 10 0 90 0 {lab=VSS}
N 100 130 110 130 {lab=VSS}
N 330 120 410 120 {lab=#net2}
N 90 -370 310 -370 {lab=VDD}
N -90 -300 -70 -300 {lab=VDD}
N -90 -370 -90 -300 {lab=VDD}
N -90 -370 -70 -370 {lab=VDD}
N 330 -370 330 -290 {lab=VDD}
N 330 -260 350 -260 {lab=VDD}
N 350 -370 350 -260 {lab=VDD}
N 330 -370 350 -370 {lab=VDD}
N 90 -300 110 -300 {lab=VDD}
N 110 -370 110 -300 {lab=VDD}
N 240 -260 260 -260 {lab=Vout1}
N 310 -370 330 -370 {lab=VDD}
N 130 -140 150 -140 {lab=VP}
N 210 210 230 210 {lab=#net1}
N 220 50 240 50 {lab=EN}
N 540 300 560 300 {lab=#net2}
N 150 -140 160 -140 {lab=VP}
N 180 -220 220 -220 {lab=VSS}
N 410 300 540 300 {lab=#net2}
N 380 300 410 300 {lab=#net2}
N 330 300 380 300 {lab=#net2}
N 240 300 330 300 {lab=#net2}
N -370 70 -270 70 {lab=#net1}
N -270 70 -270 130 {lab=#net1}
N 330 150 330 300 {lab=#net2}
N 10 300 240 300 {lab=#net2}
N 410 120 410 300 {lab=#net2}
N 330 0 440 0 {lab=#net2}
N 440 0 440 300 {lab=#net2}
N -420 0 -370 0 {lab=VSS}
N -420 0 -420 300 {lab=VSS}
N -420 300 -410 300 {lab=VSS}
N -400 130 -370 130 {lab=VSS}
N -400 130 -400 300 {lab=VSS}
N 330 -80 330 -30 {lab=VOUT}
N 10 220 10 280 {lab=#net2}
N -370 300 -370 430 {lab=VSS}
N -370 430 10 430 {lab=VSS}
N 10 400 10 430 {lab=VSS}
N 330 30 330 90 {lab=#net5}
C {code_shown.sym} -1530 -980 0 0 {name=NGSPICE1 only_toplevel=false value="
.lib /foss/pdks/sky130A/libs.tech/ngspice/sky130.lib.spice tt
.param vcm = 0.9
**Setup
Vdd vdd 0 1.8
Ven en 0 1.8
Ibias Vdd Ibias 5u
*Vdd vdd 0 SIN(1.8 0.1 600k)
Vss vss 0 0

*Uncomment sources below depending* 
*on what simulation needs to be run*
*AC simulation or (DC + Transient)*

*This line is not really needed -> Vdiff vdiff 0 0

*Transient + DC Transfer*
*Vdiff vdiff 0 SIN(0 0.001 1k)
*Bvp vp 0 V = vcm + V(vdiff)/2
*Bvn vn 0 V = vcm - V(vdiff)/2

*AC small signal*
Vp vp 0 vcm AC
Vn vn 0 vcm AC -1

**Simulation
.option temp=27 gmin=1e-12
.save all
.options savecurrents
.control
** Define input signal
let fsig = 1k
let tper = 1/fsig
** Define transient params
let tstop = 10*tper
let tstep = 0.001*tper

op
remzerovec
write two_stage_op_amp.raw
echo ---xm2---
let gds2 = @m.xm2.msky130_fd_pr__nfet_01v8_lvt[gds]
let ro2 = 1/gds2
echo ---xm4---
let gds4 = @m.xm4.msky130_fd_pr__pfet_01v8[gds]
let ro4 = 1/gds4
let RoD = 1/((1/ro2) + (1/ro4))
echo ---xm6---
print @m.xm6.msky130_fd_pr__nfet_01v8_lvt[vdsat]
echo -----COMMON SOURCE-----
echo ---xm7---
let gds7 = @m.xm7.msky130_fd_pr__pfet_01v8[gds]
let gm7 = @m.xm7.msky130_fd_pr__pfet_01v8[gm]
let r_zero = 1/gm7
print r_zero
let ro7 = 1/gds7
echo ---xm8---
let gds8 = @m.xm8.msky130_fd_pr__nfet_01v8_lvt[gds]
let ro8 = 1/gds8
echo ---xm10---
let gds10 = @m.xm10.msky130_fd_pr__nfet_01v8_lvt[gds]
let ro10 = 1/gds10
let Ros = 1/((1/ro7) + (1/(ro8+ro10)))


tran $&tstep $&tstop
let current = -i(vdd)
plot vp vn vout1
plot vp vn vout

dc vdiff -0.9 0.9 10m
let vin = vp -vn
plot vin vout1 vdd
meas dc vout1_at_zero find vout1 when vdiff=0

dc vdiff -0.9 0.9 10m
let vin = vp -vn
plot vin vout vdd
meas dc vout_at_zero find vout when vdiff=0

ac dec 200 10 10000Meg
let vin = vp - vn
let gain = db(vout/vin)
plot gain
meas ac gain_max MAX gain
let db_3 = gain_max - 3
print db_3
meas ac f_pole WHEN gain = db_3
meas ac f_u WHEN gain = 0
meas ac gain_10k FIND gain AT=10e3
let phase_deg = 180*cph(vout/vin)/pi
plot phase_deg
meas ac phase_at_fu FIND phase_deg AT=f_u
let phase_margin = 180 + phase_at_fu
print phase_margin
setplot op1
print @m.xm2.msky130_fd_pr__nfet_01v8_lvt[vth]
print @m.xm2.msky130_fd_pr__nfet_01v8_lvt[gm]
print @m.xm2.msky130_fd_pr__nfet_01v8_lvt[vdsat]
print @m.xm7.msky130_fd_pr__pfet_01v8[vth]
print @m.xm7.msky130_fd_pr__pfet_01v8[gm]
print @m.xm7.msky130_fd_pr__pfet_01v8[vdsat]
print ro2
print ro4
print RoD
print ro10
print ro8
print ro8+ro10
print ro7
print Ros
let ro5 = 1/@m.xm5.msky130_fd_pr__nfet_01v8_lvt[gds]
print ro5
let Av1 = @m.xm2.msky130_fd_pr__nfet_01v8_lvt[gm] * RoD
let Av2 = @m.xm7.msky130_fd_pr__pfet_01v8[gm] * Ros
print Av1
print Av2
let x7_gm_id = @m.xm7.msky130_fd_pr__pfet_01v8[gm]/@m.xm7.msky130_fd_pr__pfet_01v8[id]
print x7_gm_id
let x4_gm_id = @m.xm4.msky130_fd_pr__pfet_01v8[gm]/@m.xm4.msky130_fd_pr__pfet_01v8[id]
print x4_gm_id
let x2_gm_id = @m.xm2.msky130_fd_pr__nfet_01v8_lvt[gm]/@m.xm2.msky130_fd_pr__nfet_01v8_lvt[id]
print x2_gm_id
.endc
"}
C {iopin.sym} 10 430 1 0 {name=p4 lab=VSS}
C {lab_wire.sym} -120 -140 0 0 {name=p7 sig_type=std_logic lab=VN}
C {lab_wire.sym} -70 -200 0 0 {name=p8 sig_type=std_logic lab=Vpo}
C {lab_wire.sym} 150 -140 0 0 {name=p9 sig_type=std_logic lab=VP}
C {devices/launcher.sym} -300 -210 0 0 {name=h15
descr="Annotate OP" 
tclcommand="set show_hidden_texts 1; xschem annotate_op"
}
C {lab_wire.sym} 240 -260 0 0 {name=p10 sig_type=std_logic lab=Vout1}
C {lab_wire.sym} -10 -90 0 0 {name=p11 sig_type=std_logic lab=ITAIL}
C {iopin.sym} 10 -430 3 0 {name=p3 lab=VDD}
C {iopin.sym} -370 -310 3 0 {name=p6 lab=IBIAS}
C {opin.sym} 640 -170 0 0 {name=p13 lab=VOUT}
C {lab_wire.sym} 460 -170 0 0 {name=p21 sig_type=std_logic lab=VOUT}
C {capa.sym} 560 -80 0 0 {name=C1
m=1
value=25p
footprint=1206
device="ceramic capacitor"}
C {iopin.sym} -100 0 2 0 {name=p5 lab=EN}
C {iopin.sym} -150 -140 2 0 {name=p12 lab=VN}
C {iopin.sym} 160 -140 0 0 {name=p1 lab=VP}
C {sky130_fd_pr/pfet_01v8.sym} 310 -260 0 0 {name=M7
W=1
L=0.4
nf=1
mult=18
ad="'int((nf+1)/2) * W/nf * 0.29'" 
pd="'2*int((nf+1)/2) * (W/nf + 0.29)'"
as="'int((nf+2)/2) * W/nf * 0.29'" 
ps="'2*int((nf+2)/2) * (W/nf + 0.29)'"
nrd="'0.29 / W'" nrs="'0.29 / W'"
sa=0 sb=0 sd=0
model=pfet_01v8
spiceprefix=X
}
C {sky130_fd_pr/pfet_01v8.sym} 70 -300 0 0 {name=M4
W=4
L=0.4
nf=4
mult=1
ad="'int((nf+1)/2) * W/nf * 0.29'" 
pd="'2*int((nf+1)/2) * (W/nf + 0.29)'"
as="'int((nf+2)/2) * W/nf * 0.29'" 
ps="'2*int((nf+2)/2) * (W/nf + 0.29)'"
nrd="'0.29 / W'" nrs="'0.29 / W'"
sa=0 sb=0 sd=0
model=pfet_01v8
spiceprefix=X
}
C {sky130_fd_pr/pfet_01v8.sym} -50 -300 0 1 {name=M3
W=4
L=0.4
nf=4
mult=1
ad="'int((nf+1)/2) * W/nf * 0.29'" 
pd="'2*int((nf+1)/2) * (W/nf + 0.29)'"
as="'int((nf+2)/2) * W/nf * 0.29'" 
ps="'2*int((nf+2)/2) * (W/nf + 0.29)'"
nrd="'0.29 / W'" nrs="'0.29 / W'"
sa=0 sb=0 sd=0
model=pfet_01v8
spiceprefix=X
}
C {lab_wire.sym} 0 -140 2 0 {name=p18 sig_type=std_logic lab=VSS}
C {lab_wire.sym} 180 -220 0 0 {name=p14 sig_type=std_logic lab=VSS}
C {lab_wire.sym} 110 130 2 0 {name=p15 sig_type=std_logic lab=VSS}
C {lab_wire.sym} 90 0 2 0 {name=p16 sig_type=std_logic lab=VSS}
C {ammeter.sym} 10 370 0 0 {name=Vmeas savecurrent=true spice_ignore=0}
C {sky130_fd_pr/nfet_01v8_lvt.sym} -90 -140 0 0 {name=M1
W=56
L=1
nf=8
mult=1
ad="expr('int((@nf + 1)/2) * @W / @nf * 0.29')"
pd="expr('2*int((@nf + 1)/2) * (@W / @nf + 0.29)')"
as="expr('int((@nf + 2)/2) * @W / @nf * 0.29')"
ps="expr('2*int((@nf + 2)/2) * (@W / @nf + 0.29)')"
nrd="expr('0.29 / @W ')" nrs="expr('0.29 / @W ')"
sa=0 sb=0 sd=0
model=nfet_01v8_lvt
spiceprefix=X
}
C {sky130_fd_pr/nfet_01v8_lvt.sym} 110 -140 0 1 {name=M2
W=56
L=1
nf=8
mult=1
ad="expr('int((@nf + 1)/2) * @W / @nf * 0.29')"
pd="expr('2*int((@nf + 1)/2) * (@W / @nf + 0.29)')"
as="expr('int((@nf + 2)/2) * @W / @nf * 0.29')"
ps="expr('2*int((@nf + 2)/2) * (@W / @nf + 0.29)')"
nrd="expr('0.29 / @W ')" nrs="expr('0.29 / @W ')"
sa=0 sb=0 sd=0
model=nfet_01v8_lvt
spiceprefix=X
}
C {sky130_fd_pr/nfet_01v8_lvt.sym} -350 130 0 1 {name=M12
W=6
L=1
nf=2
mult=1
ad="expr('int((@nf + 1)/2) * @W / @nf * 0.29')"
pd="expr('2*int((@nf + 1)/2) * (@W / @nf + 0.29)')"
as="expr('int((@nf + 2)/2) * @W / @nf * 0.29')"
ps="expr('2*int((@nf + 2)/2) * (@W / @nf + 0.29)')"
nrd="expr('0.29 / @W ')" nrs="expr('0.29 / @W ')"
sa=0 sb=0 sd=0
model=nfet_01v8_lvt
spiceprefix=X
}
C {sky130_fd_pr/nfet_01v8_lvt.sym} -10 130 0 0 {name=M5
W=36
L=1
nf=12
mult=1
ad="expr('int((@nf + 1)/2) * @W / @nf * 0.29')"
pd="expr('2*int((@nf + 1)/2) * (@W / @nf + 0.29)')"
as="expr('int((@nf + 2)/2) * @W / @nf * 0.29')"
ps="expr('2*int((@nf + 2)/2) * (@W / @nf + 0.29)')"
nrd="expr('0.29 / @W ')" nrs="expr('0.29 / @W ')"
sa=0 sb=0 sd=0
model=nfet_01v8_lvt
spiceprefix=X
}
C {sky130_fd_pr/nfet_01v8_lvt.sym} 310 120 0 0 {name=M8
W=72
L=1
nf=24
mult=1
ad="expr('int((@nf + 1)/2) * @W / @nf * 0.29')"
pd="expr('2*int((@nf + 1)/2) * (@W / @nf + 0.29)')"
as="expr('int((@nf + 2)/2) * @W / @nf * 0.29')"
ps="expr('2*int((@nf + 2)/2) * (@W / @nf + 0.29)')"
nrd="expr('0.29 / @W ')" nrs="expr('0.29 / @W ')"
sa=0 sb=0 sd=0
model=nfet_01v8_lvt
spiceprefix=X
}
C {sky130_fd_pr/nfet_01v8_lvt.sym} -350 0 0 1 {name=M6
W=7
L=1
nf=1
mult=1
ad="expr('int((@nf + 1)/2) * @W / @nf * 0.29')"
pd="expr('2*int((@nf + 1)/2) * (@W / @nf + 0.29)')"
as="expr('int((@nf + 2)/2) * @W / @nf * 0.29')"
ps="expr('2*int((@nf + 2)/2) * (@W / @nf + 0.29)')"
nrd="expr('0.29 / @W ')" nrs="expr('0.29 / @W ')"
sa=0 sb=0 sd=0
model=nfet_01v8_lvt
spiceprefix=X
}
C {sky130_fd_pr/nfet_01v8_lvt.sym} -10 0 0 0 {name=M9
W=7
L=1
nf=1
mult=1
ad="expr('int((@nf + 1)/2) * @W / @nf * 0.29')"
pd="expr('2*int((@nf + 1)/2) * (@W / @nf + 0.29)')"
as="expr('int((@nf + 2)/2) * @W / @nf * 0.29')"
ps="expr('2*int((@nf + 2)/2) * (@W / @nf + 0.29)')"
nrd="expr('0.29 / @W ')" nrs="expr('0.29 / @W ')"
sa=0 sb=0 sd=0
model=nfet_01v8_lvt
spiceprefix=X
}
C {sky130_fd_pr/nfet_01v8_lvt.sym} 310 0 0 0 {name=M10
W=7
L=1
nf=1
mult=1
ad="expr('int((@nf + 1)/2) * @W / @nf * 0.29')"
pd="expr('2*int((@nf + 1)/2) * (@W / @nf + 0.29)')"
as="expr('int((@nf + 2)/2) * @W / @nf * 0.29')"
ps="expr('2*int((@nf + 2)/2) * (@W / @nf + 0.29)')"
nrd="expr('0.29 / @W ')" nrs="expr('0.29 / @W ')"
sa=0 sb=0 sd=0
model=nfet_01v8_lvt
spiceprefix=X
}
C {sky130_fd_pr/res_xhigh_po_0p35.sym} 240 -220 0 0 {name=R1
L=3.5
model=res_xhigh_po_0p35
spiceprefix=X
mult=1}
C {sky130_fd_pr/cap_mim_m3_1.sym} 240 -130 0 0 {name=C2 model=cap_mim_m3_1 W=25.5 L=25.5 MF=1 spiceprefix=X}
